<!DOCTYPE html>
<html>
<head>
    <title>Manage animal</title>
    <script>
        window.onload = function() {
            loadAnimal();
        };

        function loadAnimal() {
            fetch(`{{ url_for('handle_animals') }}`)
                .then(response => response.json())
                .then(data => {
                    let animalList = document.getElementById("animalList");
                    animalList.innerHTML = "";
                    let animalOptions = document.getElementById("animalId");
                    animalOptions.innerHTML = "";

                    // Dodaj domyślną opcję wyboru
                    let defaultOption = document.createElement("option");
                    defaultOption.value = -1;
                    defaultOption.textContent = "Select an animal:";
                    animalOptions.appendChild(defaultOption);

                    data.forEach(animal => {
                        let animalItem = document.createElement("li");
                        animalItem.textContent = `Name: ${animal.name}, Race: ${animal.race}, Food_id: ${animal.food_id}, Shelter_id: ${animal.shelter_id}, Status: ${animal.status}, Sex: ${animal.sex}, Age: ${animal.age}, Weight: ${animal.weight}`;
                        animalList.appendChild(animalItem);

                        let animalOption = document.createElement("option");
                        animalOption.value = animal.id;
                        animalOption.textContent = animal.name;
                        document.getElementById("animalId").appendChild(animalOption);
                    });
                })
                .catch(error => console.error('Error:', error));
        }
        
        function handleActionChange() {
            var action = document.getElementById("action").value;
            var addAnimalForm = document.getElementById("addAnimalForm");
            var editAnimalForm = document.getElementById("editAnimalForm");
            var deleteAnimalForm = document.getElementById("deleteAnimalForm");
            var existingAnimal = document.getElementById("existingAnimal");

            if (action === "add") {
                addAnimalForm.style.display = "block";
                editAnimalForm.style.display = "none";
                deleteAnimalForm.style.display = "none";
                existingAnimal.style.display = "none";
            } else {
                if (action === "edit") {
                    addAnimalForm.style.display = "none";
                    editAnimalForm.style.display = "block";
                    deleteAnimalForm.style.display = "none";

                    // Pobierz dane dotyczące wybranego zwierzęcia
                    var selectedAnimalId = document.getElementById("animalId").value;
                    if (selectedAnimalId) {
                        fetch(`{{ url_for('handle_animals') }}/` + selectedAnimalId)
                            .then(response => response.json())
                            .then(data => {
                                // Wypełnij pola formularza danymi zwróconymi z serwera
                                document.getElementById("editName").value = data.name;
                                document.getElementById("editRace").value = data.race;
                                document.getElementById("editFoodId").value = data.food_id;
                                document.getElementById("editShelterId").value = data.shelter_id;
                                document.getElementById("editStatus").value = data.status;
                                document.getElementById("editSex").value = data.sex;
                                document.getElementById("editAge").value = data.age;
                                document.getElementById("editWeight").value = data.weight;
                            })
                            .catch(error => console.error('Error:', error));
                    }
                } else if (action === "delete") {
                    addAnimalForm.style.display = "none";
                    editAnimalForm.style.display = "none";
                    deleteAnimalForm.style.display = "block";
                }
                existingAnimal.style.display = "block";
            }
        }

        function addAnimal(event) {
            event.preventDefault();
            let formData = new FormData(event.target);
            let jsonObject = {};
            for (const [key, value]  of formData.entries()) {
                jsonObject[key] = value;
            }
            fetch(`{{ url_for('handle_animals') }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonObject)
            }).then(response => response.json())
            .then( data => {
                console.log(data)
                loadAnimal();
            })
            .catch(error => console.error('Error:', error)); 
            event.target.reset();
        };

        function deleteAnimal() {
            var animalId = document.getElementById("animalId").value;
            if (animalId <= 0) {
                alert("Select an animal to delete!");
                return;
            }
            fetch(`{{ url_for('handle_animals') }}/`+animalId, {
                method: 'DELETE'
            })
            .then(response => console.log(response))
            .then(data => {
                console.log(data);
                loadAnimal();
            })
            .catch(error => console.error('Error:', error));
        }

        function editAnimal(event) {
            event.preventDefault();
            var animalId = document.getElementById("animalId").value;
            if (animalId <= 0) {
                alert("Select an animal to edit!");
                return;
            }
            let formData = new FormData(event.target);
            let jsonObject = {};
            for (const [key, value] of formData.entries()) {
                jsonObject[key] = value;
            }
            fetch(`{{ url_for('handle_animals') }}/`+animalId, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonObject)
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                loadAnimal();
                clearEditAnimalForm(); // Dodaj funkcję do wyczyszczenia pól formularza edycji
            })
            .catch(error => console.error('Error:', error));
        }

        function clearEditAnimalForm() {
            document.getElementById("editName").value = "";
            document.getElementById("editRace").value = "";
            document.getElementById("editFoodId").value = "";
            document.getElementById("editShelterId").value = "";
            document.getElementById("editStatus").value = "";
            document.getElementById("editSex").value = "";
            document.getElementById("editAge").value = "";
            document.getElementById("editWeight").value = "";
        }
    </script>
</head>
<body>
    <h1>Manage animal</h1>
    <h2>Select action:</h2>
    <select id="action" onchange="handleActionChange()">
        <option value="add">Add</option>
        <option value="edit">Edit</option>
        <option value="delete">Delete</option>
    </select>

    <div id="existingAnimal" style="display: none;">
        <h2>Choose an animal:</h2>
        <select id="animalId" onchange="handleActionChange()">
            <option value="">Select an animal</option>
        </select>
    </div>

    <div id="addAnimalForm">
        <h2>Add animal</h2>
        <form method="POST" onsubmit="addAnimal(event)">
            <label for="name">Name:</label>
            <input type="text" id="name" name="name" required><br>
    
            <label for="race">Race:</label>
            <input type="text" id="race" name="race" required><br>
    
            <label for="food_id">Food Id:</label>
            <input type="number" id="food_id" name="food_id"  required><br>   

            <label for="shelter_id">Shelter_id:</label>
            <input type="number" id="shelter_id" name="shelter_id" required><br>   

            <label for="status">Status:</label>
            <input type="text" id="status" name="status" required><br>   

            <label for="sex">Sex:</label>
            <input type="text" id="sex" name="sex" required><br>   

            <label for="age">Age:</label>
            <input type="number" id="age" name="age" step="0.1" required><br>   

            <label for="weight">Weight:</label>
            <input type="number" id="weight" name="weight" step="0.1" required><br>   

            <button type="submit">Add animal</button>
        </form>
    </div>

    <div id="editAnimalForm" style="display: none;">
        <h2>Edit animal</h2>
        <form method="POST" onsubmit="editAnimal(event)">
            <label for="editName">Name:</label>
            <input type="text" id="editName" name="name" required><br>
    
            <label for="editRace">Race:</label>
            <input type="text" id="editRace" name="race" required><br>
    
            <label for="editFoodId">Food Id:</label>
            <input type="number" id="editFoodId" name="food_id"  required><br>   

            <label for="editShelterId">Shelter_id:</label>
            <input type="number" id="editShelterId" name="shelter_id" required><br>   

            <label for="editStatus">Status:</label>
            <input type="text" id="editStatus" name="status" required><br>   

            <label for="editSex">Sex:</label>
            <input type="text" id="editSex" name="sex" required><br>   

            <label for="editAge">Age:</label>
            <input type="number" id="editAge" name="age" step="0.1" required><br>   

            <label for="editWeight">Weight:</label>
            <input type="number" id="editWeight" name="weight" step="0.1" required><br>   

            <button type="submit">Edit animal</button>
        </form>
    </div>

    <div id="deleteAnimalForm" style="display: none;">
        <h2>Delete animal</h2>
        <button onclick="deleteAnimal()">Delete</button>
    </div>

    <div></div>
        <h2>All animals:</h2>
        <ul id="animalList">
        </ul>
    </div>
</body>
</html>
